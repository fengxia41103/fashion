{% extends "erp/common/base.html" %}

{% load crispy_forms_tags %}
{% load static %}
{% block page-header %}
	销售订单: {{ object.code }}
{% endblock %}

{% block content %}
<div class="row text-center">
	{% if object.is_editable %}
		<button class="btn btn-small btn-default"
		data-toggle="modal" data-target="#so-edit">
			<i class='fa fa-pencil'></i>
			Edit
		</button>		
		<button class="btn btn-small btn-danger"
		data-toggle="modal" data-target="#so-delete">
			<i class='fa fa-pencil'></i>
			Cancel order
		</button>
	{% endif %}
		<button class="btn btn-small">
			<a href="{% url 'so_fullfill_add' object.id %}">
				<i class='fa fa-pencil'></i>
				Create a fullfillment
			</a>
		</button>	
</div>

{# order header #}
<h2>Summary</h2>
<div class="panel panel-default">
  	<div class="panel-body">
	<div class="row ">
		<div class="col-md-2"><label>Customer</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.customer }}</div>
		<div class="col-md-1"></div>
		<div class="col-md-2"><label>Sales</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.sales }}</div>
		<div class="col-md-1"></div>		
	</div><div class="row">
		<div class="col-md-2"><label>Created On</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.created_on }}</div>
		<div class="col-md-1"></div>		
		<div class="col-md-2"><label>Created By</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.created_by }}</div>
		<div class="col-md-1"></div>		
	</div><div class="row">
		<div class="col-md-2"><label>Discount</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.discount_in_pcnt }}</div>
		<div class="col-md-1"></div>		
		<div class="col-md-2"><label>Sales Type</label></div>
		<div class="col-md-3 my-sf-display-border">
		<label class="label label-info">{{ object.business_model }}</label></div>
		<div class="col-md-1"></div>		
	</div><div class="row">
		<div class="col-md-2"><label>Total Line Items</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.line_item_qty }}</div>
		<div class="col-md-1"></div>		
		<div class="col-md-2"><label>Total QTY</label></div>
		<div class="col-md-3 my-sf-display-border dropdown">
			<span class="dropdown-toggle" id="total-qty-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
				{{ object.total_qty }}
				<span class="caret"></span>
			</span>
			<ul class="dropdown-menu" aria-labelledby="total-qty-dropdown">
				{% for brand,data in items.iteritems %}
					<li>
						<a><label>{{ brand }}:</label> {{ data.total_qty }}</a>
					</li>
				{% endfor %}
			</ul>		
		</div>		
		<div class="col-md-1"></div>		
	</div><div class="row">
		<div class="col-md-2"><label>Retail Value</label></div>
		<div class="col-md-3 my-sf-display-border item-price-original">
			{{object.customer.currency}}
			{{ object.total_std_value|floatformat:0 }}
		</div>
		<div class="col-md-1"></div>		
		<div class="col-md-2"><label>Value On Order</label></div>
		<div class="col-md-3 my-sf-display-border dropdown">
			<span class="dropdown-toggle" id="total-value-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
				{{object.customer.currency}}
				{{ object.total_discount_value|floatformat:2 }}
				<span class="caret"></span>
			</span>
			<ul class="dropdown-menu" aria-labelledby="total-value-dropdown">
				{% for brand,data in items.iteritems %}
					<li>
						<a><label>{{ brand }}:</label> 
							{{object.customer.currency}}
							{{ data.total_value|floatformat:2 }}
						</a>
					</li>
				{% endfor %}
			</ul>		
		</div>
		<div class="col-md-1"></div>
	</div>
  </div>
</div>

<h2>Fullfillments</h2>
<div class="panel panel-default">
  	<div class="panel-body">
	<div class="row">	
		<div class="col-md-2"><label>Fullfiller</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.default_storage }}</div>
		<div class="col-md-1"></div>	
		<div class="col-md-2"><label>Last Fullfillment Date</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.last_fullfill_date }}&nbsp;</div>
		<div class="col-md-1"></div>			
	</div><div class="row">
		<div class="col-md-2"><label>Fullfilled QTY</label></div>
		<div class="col-md-3 my-sf-display-border">
			{% if object.fullfill_qty > 0 %}
			<span class="dropdown-toggle" id="fullfillments-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
				{{ object.fullfill_qty|floatformat:0 }}
				<span class="caret"></span>
			</span>
			<ul class="dropdown-menu" aria-labelledby="fullfillments-dropdown" style="padding:10px 20px;">
				<table class="table table-striped table-hover">
					<thead>
						<th>Fullfillment</th>
						<th>QTY</th>
						<th>Created On</th>
					</thead>

					<tbody>
						{% for f in object.fullfillments %}
							<tr><td>
								{{ f.code }}
							</td><td>
								{{ f.qty }}
							</td><td>
								{{ f.created_on }}
							</td></tr>
						{% endfor %}
					</tbody>
				</table>
			</ul>
			{% else %}
				&nbsp;
			{% endif %}
		</div>
		<div class="col-md-1"></div>	
		<div class="col-md-2"><label>Fullfill Rate By QTY</label></div>
		<div class="col-md-3 my-sf-display-border">
			{{ object.fullfill_rate_by_qty|floatformat:0 }}%
		</div>
		<div class="col-md-1"></div>				
	</div><div class="row">
		<div class="col-md-2"><label>Fullfilled Value</label></div>
		<div class="col-md-3 my-sf-display-border">
		{{object.customer.currency}}
		{{ object.fullfill_discount_value|floatformat:2 }}&nbsp;</div>
		<div class="col-md-1"></div>	
		<div class="col-md-2"><label>Fullfill Rate By Value</label></div>
		<div class="col-md-3 my-sf-display-border">
			{{ object.fullfill_rate_by_value|floatformat:0 }}%
		</div>			
		<div class="col-md-1"></div>	
	</div>
	</div>{# end of panel body #}
</div>

<h2>Payments</h2>
<div class="panel panel-default">
  	<div class="panel-body">
	<div class="row">	
		<div class="col-md-2"><label>Paid</label></div>
		<div class="col-md-3 my-sf-display-border">{{ object.total_payment|floatformat:2 }}</div>
		<div class="col-md-1"></div>	
		<div class="col-md-2"><label>Account Receivable</label></div>
		<div class="col-md-3 my-sf-display-border">
			{{object.customer.currency}}
			{{ object.account_receivable|floatformat:2 }}

			{% if object.account_receivable > 0 %}
				<a class="pull-right" data-toggle="modal" data-target="#new-payment">
					<i class='fa fa-money'></i>
					make payment
				</a>
			{% endif %}
		</div>			
		<div class="col-md-1"></div>
	</div><div class="row">
		<div class="col-md-2"><label>Payment History</label></div>
		<div class="col-md-9">
			{% for f in object.payments %}
				{% if f.is_deposit %}
					<span data-toggle="tooltip" title="This is a deposit">
					{{ f.amount|floatformat:2 }}
					<sup>D</sup>
					</span>
				{% else %}
					{{ f.amount|floatformat:2 }}
					{% if f.is_editable %}
						<sup>E</sup>
					{% endif %}
				{% endif %}

				{% if not forloop.last %} 
					+ 
				{% endif %}
			{% endfor %}
		</div>
		<div class="col-md-1"></div>
	</div>
	</div>
</div>

{# order details #}
<h2>Order Details</h2>
<ul class="nav nav-tabs" role="tablist">
	{% for brand,data in items.iteritems %}
	<li>
	  <a href="#brand-{{brand.id}}" role="tab" data-toggle="tab">
	      <icon class="fa fa-folder"></icon> {{ brand }}
	  </a>
	</li>
	{% endfor %}
</ul>

<!-- Tab panes -->
<div class="tab-content">
{% for brand,data in items.iteritems %}
	<div class="tab-pane" id="brand-{{brand.id}}">
		{% for item,detail in data.items.iteritems %}
		<div class="row" style="border-bottom:1px dashed #bcbcbc; padding:10px 0px;">
			{# item image #}
			<div class="col-md-2">
				{% with item.attachments.all.0 as item_img %}
					<img src="{{item_img.file.url}}"
					data-type="attachment-thumbnail" class="img-responsive img-thumbnail"
					style="width:90%;">
				{% endwith %}
			</div>		
			<div class="col-md-4">
				<h4 style="font-weight:bold;font-size:20px;">
				{{ item.name|upper }}
				</h4>
				<p>
				<a href="{% url 'item_detail' item.id %}">
					<i class="fa fa-hand-o-right"></i>
					SKU {{ item.product_id }}
				</a>
				</p>				
				
				{# color #}
				<p>
					<span class="item-label">COLOR:
					</span><span class="item-value">{{ item.color }}</span>
					<span class="item-label">SEASON:
					</span><span class="item-value">{{ item.season }}</span>					
				</p>
				
				<p class="item-price-original">
					{{object.customer.currency}}
					{{ item.price|floatformat:0 }}				
				</p>
				<p class="on_sale">
					<label>On sale:</label>
					{{object.customer.currency}}
					{{ detail.so_line_items.0.discount_price|floatformat:2 }}
				</p>
				<p>
					<span class="badge">You save: </span>{{object.customer.currency}}{{ detail.so_line_items.0.you_save|floatformat:0 }}
				</p>
			</div>

			{# fullfillment details #}
			<div class="col-md-4">
				<h4 class="my-section-header">
				<span class="item-label">Order Value:</span> 
				<span class="">
					{{object.customer.currency}}
					{{ detail.value|floatformat:2 }}
				</span>
				</h4>			

				{# order QTY details #}
				<dl class="dl-horizontal" style="margin-top:20px;">
					<dt>Size:</dt><dd></dd>

					{% for so_line_item in detail.so_line_items %}
					
					{# size #}
					<dt>
						{{so_line_item.item.size}}
					</dt>

					{# qty #}
					<dd>
						{% if so_line_item.is_editable %}
							{# qty input box #}
							<input type="number" value="{{so_line_item.qty}}" style="width:50px;" data-toggle="order-qty">

							{# remove line item #}
							<a href="{% url 'so_remove_item' so_line_item.id %}"
							data-toggle="tooltip"
							title="Remove this from order">
								<i class="fa fa-trash">remove</i>
							</a>
						{% else %}
							{# qty input box #}
							<input type="number" value="{{ so_line_item.fullfill_qty }}" style="width:50px;" disabled> / {{so_line_item.qty}}						
						{% endif %}
					</dd>
					{% endfor %}
				</dl>

				<div style="border-top:1px solid #dcdcdc;" class="">
					<dl class='dl-horizontal'>
						<dt>
							<label class="label label-default">Subtotal QTY</label>
						</dt>
						<dd>
							<span class="item-value">
								{{ detail.qty }}
							</span>
						</dd>
					</dl>
				</div>
			</div>
		</div>
		{% endfor %}

		<div class="row" style="margin-top:10px;">
			<div class="col-md-offset-6 col-md-3 text-right">
				<label class="">{{brand}} total QTY:</label>
			</div><div class="col-md-2">
				<span class="item-total">{{ data.total_qty }}</span>
			</div>
		</div><div class="row">
			<div class="col-md-offset-6 col-md-3 text-right">
				<label class="">{{brand}} total value:</label>
			</div><div class="col-md-2">
				<span class="item-total">
				{{object.customer.currency}}{{ data.total_value|floatformat:2 }}
				</span>
			</div>
		</div>
	</div>
{% endfor %}
</div>    
{% endblock %}

{% block modal %}
{# SO edit modal #}
<div id="so-edit" class="modal fade" role="dialog">
<div class="modal-dialog">
<form action="{% url 'so_edit' object.id %}" method="POST">
 
    <!-- Modal content-->
    <div class="modal-content">

    	{# Modal header #}
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Edit {{ object.code }}</h4>
      </div>

      {# Modal body #}
      <div class="modal-body">	
			{% csrf_token %}
			{{ so_edit_form|crispy }}
      </div>

      {# Modal footer #}
      <div class="modal-footer">
		<button class="btn btn-primary" type="submit">
			<i class="fa fa-save"></i>
			<span>Save</span>
		</button>      
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>
</form>          
</div>
</div>

{# Add payment modal #}
<div id="new-payment" class="modal fade" role="dialog">
<div class="modal-dialog">
<form action="{% url 'so_payment_add' %}" method="POST">
    <!-- Modal content-->
    <div class="modal-content">
		{# Modal header #}
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal">&times;</button>
	        <h4 class="modal-title">Register a payment</h4>
		</div>

	    {# Modal body #}
	    <div class="modal-body">			
			{% csrf_token %}
			{{ so_payment_add_form|crispy }}
		</div>

	      {# Modal footer #}
		<div class="modal-footer">
			<button class="btn btn-primary"  type="submit">
				<i class="fa fa-save"></i>
				<span>Register payment</span>
			</button>      
	        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
		</div>
	</div>
</form>
</div>
</div>

{# Delete SO modal #}
<div id="so-delete" class="modal fade" role="dialog">
<div class="modal-dialog">
<form action="{% url 'so_delete' object.id %}" method="POST">
 
    <!-- Modal content-->
    <div class="modal-content">

    	{# Modal header #}
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">To Cancel {{ object.code }}</h4>
      </div>

      {# Modal body #}
      <div class="modal-body alert alert-warning">	
			{% csrf_token %}
			<p>Order cancellation is not recoverable.</p>

			<p>
			Are you sure to cancel this order?
			</p>
      </div>

      {# Modal footer #}
      <div class="modal-footer">
		<button class="btn btn-primary" type="submit">
			<i class="fa fa-check">Yes</i>
		</button>      
        <button type="button" class="btn btn-default" data-dismiss="modal">
        	<i class="fa fa-close">No</i>
        </button>
      </div>
    </div>
</form>          
</div>
</div>

{% endblock %}

{% block custom_js %}
<script type="text/javascript">
var j$ = jQuery.noConflict();
j$(document).ready(function(){
	// starting first tab
	j$('[data-toggle="tab"]:first').tab('show');

	j$(document).delegate('*[data-toggle="lightbox"]', 'click', function(e) {
	    e.preventDefault();
	    j$(this).ekkoLightbox();
	}); 

	j$('[data-type="attachment-thumbnail"]').click(function(){
		var url = j$(this).attr('src');
		j$(this).closest('section').find('[data-toggle="lightbox"]').attr('href',url);
		j$(this).closest('section').find('[data-toggle="lightbox"]').find('img:first-child').attr('src',url);
	});	

	j$('input[data-toggle="order-qty"]').change(function(){
		console.log(j$(this).val());
	});
});
</script>
{% endblock %}